<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.care.stay.hotel.HotelMapper">
	<resultMap type="com.care.stay.hotel.HotelDTO" id="HotelDto">
		<id column="no" property="no"/>
		<result column="hcode" property="hcode"/>
		<result column="hname" property="hname"/>
		<result column="hregion" property="hregion"/>
		<result column="hdetailregion" property="hdetailregion"/>
		<result column="hrating" property="hrating"/>
		<result column="haddress" property="haddress"/>
		<result column="hdetailaddress" property="hdetailaddress"/>
		<result column="himage" property="himage"/>
		<result column="hinfo" property="hinfo"/>
		<result column="hcheckintime" property="hcheckintime"/>
		<result column="hcheckouttime" property="hcheckouttime"/>
		<result column="htype" property="htype"/>

	</resultMap> 
	
 	 <resultMap type="com.care.stay.hotel.HotelRoomDTO" id="HotelRoomDto">
        <result  column="no" property="no" />
        <result  column="hcode" property="hcode" />
        <result  column="hroomcode" property="hroomcode" />
        <result  column="hroomname" property="hroomname" />
        <result  column="hbedtype" property="hbedtype" />
        <result  column="hroomimage" property="hroomimage" />
        <result  column="hroomnumber" property="hroomnumber" />
        <result  column="hprice" property="hprice" />
        <result  column="hpeople" property="hpeople" />
        <result  column="hcomfort" property="hcomfort" />
    </resultMap>
    

	 
	 
	  <resultMap type="com.care.stay.reservation.ReservationDTO" id= "ReservationDto">
        <result  column="no" property="no" />
        <result  column="stayno" property="stayno" />
        <result  column="stayname" property="stayname" />
        <result  column="roomname" property="roomname" />
        <result  column="code" property="code" />
        <result  column="roomcode" property="roomcode" />
        <result  column="roomimage" property="roomimage" />
        <result  column="checkindate" property="checkindate" />
        <result  column="checkoutdate" property="checkoutdate" />
        <result  column="checkintime" property="checkintime" />
        <result  column="checkouttime" property="checkouttime" />
        <result  column="id" property="id" />
        <result  column="name" property="name" />
        <result  column="price" property="price" />
        <result  column="paymethod" property="paymethod" />
        <result  column="status" property="status" />
    </resultMap>
	 
	 
	 
	 


<!-- 	<select id="hotellist" resultMap="HotelDto">  
		SELECT BBB.* 
		FROM (SELECT ROWNUM() as rn, AAA.* 
		FROM (SELECT no, hcode, hname, hregion, hdetailregion, hrating, haddress, hdetailaddress, himage, hinfo, hcheckintime, hcheckouttime, htype
		FROM hotel ORDER BY no DESC )AAA)BBB
		WHERE BBB.rn BETWEEN #{begin} AND #{end}
	</select> -->
	
<!--  전체 다 나오는 코드인데 처음부터 지역 지정해서 하는 코드로 바꿔보려함! (아래) -->
  	<select id="hotellist" resultMap="HotelDto">
		SELECT BBB.* FROM 
		(SELECT ROWNUM as rn, AAA.* FROM 
		(SELECT no, hcode, hname, hregion, hdetailregion, hrating, haddress, hdetailaddress, 
		himage, hinfo, hcheckintime, hcheckouttime, htype
		FROM hotel ORDER BY no DESC)AAA)BBB
		WHERE BBB.rn BETWEEN #{begin} AND #{end}
	</select>  
	
		<!-- 지역별로 나오게하기  -->
 	<select id="Main" resultMap="HotelDto">
		SELECT BBB.* FROM 
		(SELECT ROWNUM as rn, AAA.* FROM 
		(SELECT no, hcode, hname, hregion, hdetailregion, hrating, haddress, hdetailaddress, 
		himage, hinfo, hcheckintime, hcheckouttime, htype
		FROM hotel WHERE hdetailregion = #{selectedText})AAA)BBB
		WHERE BBB.rn BETWEEN #{begin} AND #{end}
	</select>  
	
	<!-- 날짜별로 나오게하기  -->
 <!-- 		<select id="MainDate" resultMap="ReservationDto">
		SELECT BBB.* FROM 
		(SELECT ROWNUM as rn, AAA.* FROM 
		(SELECT reservation.*
		FROM reservation WHERE checkindate = #{checkindate} AND checkoutdate = #{checkoutdate} )AAA)BBB
		WHERE BBB.rn BETWEEN #{begin} AND #{end}
	</select>  
	 -->
	
	
	<!-- 지역과 체크박스별로 나오게하기   -->
 	<!--   1차시도  -->

 <!-- 	<select id="MainCheck">
  	 SELECT h.*, hr.*, rs.*
	 FROM hotel h 
	 JOIN hotelroom hr  
	 	ON hr.hcode = h.hcode
	 JOIN reservation rs
	 	ON hr.hroomname = rs.roomname
	 WHERE (h.hdetailregion = #{selectedText}
	 OR rs.checkindate = #{checkindate}
	 OR rs.checkoutdate = #{checkoutdate}
   	 OR h.htype = #{htype})
     AND( hr.hbedtype = #{hbedtype}
     OR hr.hcomfort like CONCAT('%'|| #{hcomfort}, '%')
     OR hr.hpeople = #{hpeople})
     
	</select>    -->
	
	
	<!-- checkin out 제외  -->
<!-- 	<select id="MainCheck">
  	 SELECT h.*, hr.*
	 FROM hotel h 
	 JOIN hotelroom hr  ON hr.hcode = h.hcode
	 WHERE (h.hdetailregion = #{selectedText}
   	 OR h.htype = #{htype})
     AND( hr.hbedtype = #{hbedtype}
     OR hr.hcomfort like CONCAT('%'|| #{hcomfort}, '%')
     OR hr.hpeople = #{hpeople})
     
	</select> -->
	
	
	<!-- 호텔룸 컬럼은 제외  -->
 <!-- 	<select id="MainCheck">
  	 SELECT h.*, hr.*
	 FROM hotel h 
	 JOIN hotelroom hr  ON hr.hcode = h.hcode
	   WHERE (h.hdetailregion = #{selectedText} OR h.htype = #{htype})
   	   AND hr.hbedtype = #{hbedtype}
       AND (hr.hcomfort LIKE CONCAT('%', #{hcomfort}, '%')
       OR hr.hpeople = #{hpeople}
     
     
	</select>  -->
	

 <!-- 2차시도  이거! -->	
<!-- 	 <select id="MainCheck">
  	 SELECT h.no, h.hcode, h.hname, h.hregion, h.hdetailregion, h.hrating, h.haddress, h.hdetailaddress, h.himage, h.hinfo, h.hcheckintime, h.hcheckouttime, h.htype,
			hr.no, hr.hcode, hr.hroomcode, hr.hroomname, hr.hbedtype, hr.hroomimage, hr.hroomnumber, hr.hprice, hr.hpeople, hr.hcomfort
	 FROM hotel h 
	 JOIN hotelroom hr  ON hr.hcode = h.hcode
	   WHERE (h.hdetailregion = #{selectedText} OR h.htype = #{htype})
        AND (hr.hbedtype = #{hbedtype}
        AND hr.hcomfort LIKE CONCAT('%'|| #{hcomfort}, '%')
       OR hr.hpeople = #{hpeople})
 
	</select>   -->
	

	
	
 <!-- 3차시도  이건 조건에 안걸림 -->	
	<!--  <select id="MainCheck">
  	 SELECT h.no, h.hcode, h.hname, h.hregion, h.hdetailregion, h.hrating, h.haddress, h.hdetailaddress, h.himage, h.hinfo, h.hcheckintime, h.hcheckouttime, h.htype,
			hr.no, hr.hcode, hr.hroomcode, hr.hroomname, hr.hbedtype, hr.hroomimage, hr.hroomnumber, hr.hprice, hr.hpeople, hr.hcomfort
	 FROM hotel h 
	 JOIN hotelroom hr  ON hr.hcode = h.hcode
	   WHERE (h.hdetailregion = #{selectedText} OR h.htype IN #{htype})
        AND (hr.hbedtype IN #{hbedtype}
        AND hr.hcomfort IN #{hcomfort}
       OR hr.hpeople = #{hpeople})
 
	</select>  -->
	
	
	
<!-- 4차시도  foreach 사용하기    오류가생김  -->	
<!-- <select id="MainCheck">
    SELECT h.no, h.hcode, h.hname, h.hregion, h.hdetailregion, h.hrating, h.haddress, h.hdetailaddress, h.himage, h.hinfo, h.hcheckintime, h.hcheckouttime, h.htype,
           hr.no, hr.hcode, hr.hroomcode, hr.hroomname, hr.hbedtype, hr.hroomimage, hr.hroomnumber, hr.hprice, hr.hpeople, hr.hcomfort
    FROM hotel h 
    JOIN hotelroom hr ON hr.hcode = h.hcode
    WHERE (h.hdetailregion = #{selectedText}  OR h.htype IN #{htype})
    AND hr.hbedtype IN
        <foreach item="item" index="index" collection="hbedtype" open="(" separator="," close=")">
            #{item}
        </foreach>
   	AND hr.hcomfort IN #{hcomfort}
    AND hr.hpeople = #{hpeople}
</select> -->



<!-- <select id="MainCheck" parameterType="HotelParameters" resultMap="결과_매핑_지정">
    SELECT h.no, h.hcode, h.hname, h.hregion, h.hdetailregion, h.hrating, h.haddress, h.hdetailaddress, h.himage, h.hinfo, h.hcheckintime, h.hcheckouttime, h.htype,
           hr.no, hr.hcode, hr.hroomcode, hr.hroomname, hr.hbedtype, hr.hroomimage, hr.hroomnumber, hr.hprice, hr.hpeople, hr.hcomfort
    FROM hotel h 
    JOIN hotelroom hr ON hr.hcode = h.hcode
    WHERE (h.hdetailregion = #{selectedText} OR h.htype IN
        <foreach item="type" collection="htype" open="(" separator="," close=")">
            #{type}
        </foreach>
    )
    AND hr.hbedtype IN
        <foreach item="bedType" collection="hbedtype" open="(" separator="," close=")">
            #{bedType}
        </foreach>
    AND hr.hcomfort IN
        <foreach item="comfort" collection="hcomfort" open="(" separator="," close=")">
            #{comfort}
        </foreach>
    AND hr.hpeople = #{hpeople}
</select> -->


<!-- 3개테이블 합치려는 시도 -->
<!-- 	<select id="MainCheck">
  	 SELECT h.*, hr.*, rs.*
	 FROM hotel h hotelroom hr reservation rs
	 WHERE (h.hdetailregion = #{selectedText}

   	 OR h.htype = #{htype})
   	 
   	 AND(rs.checkindate = #{checkindate} AND rs.checkoutdate = #{checkoutdate})
   	 
     AND(hr.hbedtype like CONCAT('%'|| #{hbedtype}, '%')
     
  	 AND hr.hcomfort like CONCAT('%'|| #{hcomfort}, '%')
	
     OR hr.hpeople = #{hpeople})
     
 	</select>   -->
	
	<!--	 	<select id="MainCheck">
  	 SELECT h.*, hr.*
	 FROM hotel h 
	 JOIN hotelroom hr  ON h.no = hr.no AND hr.hcode = h.hcode
	 WHERE (h.hdetailregion = #{selectedText}

     <foreach collection="array" item="arr" open="(" close=")" separator=",">
  		OR hr.hcomfort like CONCAT('%'|| #{arr}, '%')
	</foreach>

     
	</select>   
	
	 -->
	 
	 <!--  조건마다 쿼리 나누기  -->
	 
	 <!-- htye 처리 -->
	 <select id="MainCheck_htype"  resultMap="HotelDto">
    SELECT h.no, h.hcode, h.hname, h.hregion, h.hdetailregion, h.hrating, h.haddress, h.hdetailaddress, h.himage, h.hinfo, h.hcheckintime, h.hcheckouttime, h.htype
           <!-- hr.no, hr.hcode, hr.hroomcode, hr.hroomname, hr.hbedtype, hr.hroomimage, hr.hroomnumber, hr.hprice, hr.hpeople, hr.hcomfort -->
    FROM hotel h 
  <!--   JOIN hotelroom hr ON hr.hcode = h.hcode -->
    WHERE (h.hdetailregion = #{selectedText})
    <if test="htype != null and htype.size() > 0">
        AND h.htype IN
        <foreach item="type" collection="htype" open="(" separator="," close=")">
            #{type}
	        </foreach>
	    </if>
	</select>

	 <!-- hbedtype 처리 -->
	<select id="MainCheck_hbedtype"  >
	    SELECT h.no, h.hcode, h.hname, h.hregion, h.hdetailregion, h.hrating, h.haddress, h.hdetailaddress, h.himage, h.hinfo, h.hcheckintime, h.hcheckouttime, h.htype,
	           hr.no, hr.hcode, hr.hroomcode, hr.hroomname, hr.hbedtype, hr.hroomimage, hr.hroomnumber, hr.hprice, hr.hpeople, hr.hcomfort
	    FROM hotel h 
	    JOIN hotelroom hr ON hr.hcode = h.hcode
	    WHERE (h.hdetailregion = #{selectedText})
	    <if test="hbedtype != null and hbedtype.size() > 0">
	        AND hr.hbedtype IN
	        <foreach item="bedType" collection="hbedtype" open="(" separator="," close=")">
	            #{bedType}
	        </foreach>
	    </if>
	</select>
	
	
		 <!-- hcomfort 처리 -->
	<select id="MainCheck_hcomfort"  >
	    SELECT h.no, h.hcode, h.hname, h.hregion, h.hdetailregion, h.hrating, h.haddress, h.hdetailaddress, h.himage, h.hinfo, h.hcheckintime, h.hcheckouttime, h.htype,
	           hr.no, hr.hcode, hr.hroomcode, hr.hroomname, hr.hbedtype, hr.hroomimage, hr.hroomnumber, hr.hprice, hr.hpeople, hr.hcomfort
	    FROM hotel h 
	    JOIN hotelroom hr ON hr.hcode = h.hcode
	    WHERE (h.hdetailregion = #{selectedText})
	    <if test="hcomfort != null and hcomfort.size() > 0">
	        AND hr.hcomfort IN
	        <foreach item="comfort" collection="hcomfort" open="(" separator="," close=")">
	            #{comfort}
	        </foreach>
	    </if>
	</select>
		
		 <!-- hpeople 처리 -->
	<select id="MainCheck_hpeople"  >
	    SELECT h.no, h.hcode, h.hname, h.hregion, h.hdetailregion, h.hrating, h.haddress, h.hdetailaddress, h.himage, h.hinfo, h.hcheckintime, h.hcheckouttime, h.htype,
	           hr.no, hr.hcode, hr.hroomcode, hr.hroomname, hr.hbedtype, hr.hroomimage, hr.hroomnumber, hr.hprice, hr.hpeople, hr.hcomfort
	    FROM hotel h 
	    JOIN hotelroom hr ON hr.hcode = h.hcode
	    WHERE (h.hdetailregion = #{selectedText}) 
	    <if test="#{hpeople} > 0">
	        And hr.hpeople = #{hpeople, jdbcType=INTEGER}
	    </if>
	</select>
		 
	 

	
	<!-- 아래에도있음/ 나중에 합칠때 한개는 지워야함  -->
	<select id="count">
	  	SELECT count(no) FROM hotel
	</select>
	



	<resultMap type="com.care.stay.hotel.HotelDTO" id="hotelDto">
		<id column="no" property="no"/>																		
	</resultMap>
	
	<resultMap type="com.care.stay.hotel.HotelRoomDTO" id="hotelroomDto">
		<id column="hroomcode" property="hroomcode"/>
	</resultMap>
	
	<select id="stayContent" resultMap="hotelDto">
		SELECT * FROM hotel WHERE no=#{no}
	</select>
	
	<select id="roomContent" resultMap="hotelroomDto">
		SELECT * FROM hotelroom WHERE hroomcode=#{hroomcode}
	</select>
	
	<select id="stayModify" resultMap="hotelDto">
		SELECT * FROM hotel WHERE no=#{no}
	</select>
	
	<select id="stayRoomContent" resultMap="hotelroomDto">
		SELECT * FROM hotelroom WHERE no=#{no}
	</select>
	
	<select id="stayReservation" resultMap="hotelroomDto">
		SELECT * FROM hotelroom WHERE hroomcode=#{hroomcode}
	</select>
	
	<select id="stayDetailRegister" resultMap="hotelDto">
		SELECT * FROM hotel WHERE no=#{no}
	</select>

	<select id="hotelroomcount" resultType="int">
		SELECT COALESCE(nvl(max(hroomcode),0) + 1, 0) FROM hotelroom
	</select>	
	
	<select id="stayCountHotel" resultType="int">
	  	SELECT COALESCE(nvl(max(no),0) + 1, 0) FROM hotel
	</select>	
	
	<insert id="stayregisterProc" parameterType="com.care.stay.hotel.HotelDTO">
		<selectKey order="BEFORE" keyProperty="no" resultType="int">
			SELECT nvl(max(no),0) + 1 FROM hotel
		</selectKey>
		INSERT INTO hotel (no, hcode, hname, hregion, hdetailregion, hrating, haddress, hdetailaddress, himage, hinfo, hcheckintime, hcheckouttime, htype) 
		VALUES(#{no}, 'H', #{hname}, #{hregion}, #{hdetailregion}, 0, #{haddress}, #{hdetailaddress}, #{himage}, #{hinfo}, #{hcheckintime}, #{hcheckouttime}, #{htype})
	</insert>
	
	<select id="stayInfo" resultMap="hotelDto">
		SELECT BBB.* FROM 
		(SELECT rownum as rn, AAA.* FROM 
		(SELECT no, hcode, hname, hregion, haddress FROM hotel ORDER BY no DESC)AAA)BBB
		WHERE BBB.rn BETWEEN #{begin} AND #{end}
	</select>

	<insert id="staydetailregisterProc" parameterType="com.care.stay.hotel.HotelRoomDTO">
		INSERT INTO hotelroom (no, hcode, hroomcode, hroomname, hbedtype, hroomimage, hroomnumber, hprice, hpeople, hcomfort)
		VALUES(#{no}, #{hcode}, #{hroomcode}, #{hroomname}, #{hbedtype}, #{hroomimage}, #{hroomnumber}, #{hprice}, #{hpeople}, #{hcomfort})
	</insert>
	
	<select id="findMinPriceByHotel" resultType="java.lang.Integer">
		SELECT COALESCE(MIN(hprice), 0) FROM hotelroom WHERE no = #{no}
	</select>	
	
	<select id="getAllHotels" resultType="com.care.stay.hotel.HotelDTO">
		SELECT * FROM hotel
	</select>

</mapper>
